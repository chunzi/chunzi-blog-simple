Amor 模块改造

使用自己的 Amor 框架构建 web 应用程序，尝到了快速开发，高度复用的快感。对于复杂的应用系统，都可以在短短的几个小时内，搭建出相关的程序和页面流程。非常之好。

于是，终于有机会在同一个 web 服务器内同时开发或者使用三个应用。当然，开发环境下，使用 mod_cgi 方式，毫无问题。如果都在 mod_perl 下面跑，呵呵，问题具现了 -- 第一个应用可以跑，没有问题，这个时候再访问第二套系统，看到的是第一个系统的界面。原因很简单，他们都是用了同一个框架 Amor，一些应用范畴之内的变量和设定都使用了 Amor::Context 的类变量。mod_perl 下面各次请求共享同一个 Amor 类，发生这样的问题也就不奇怪了。

哎，当初写 Amor 的时候竟然忽略了这一点，实在有些说不过去。为了支持 mod_perl 从 jit_core 改写为 Amor ，而如今，为了支持 mod_perl 下面多个应用同时运行，又必须对 Amor 动手术。

动手术的过程从前天下午开始，历史三个小时，以失败告终。手术方法比较简陋，尝试将所有应用相关的变量或者设定统统放到应用程序的主要包内。发现当时的写法终究还是有些凌乱，用丑陋的写法改造时候，restart apache ，妈的，Apache 竟然程序意外出错终止。怎么弄怎么失败。我不知道究竟问题出在什么地方。只好把这些修改打包后，回溯到开始修改前的代码。

一夜无眠，第二天一早，便又准备开始第二次手术。参考了 Cataylst 的写法，觉得他的思路非常清晰和简洁，于是先按照他想法来改造我的 Amor。其实很没有面子的，大多数的东西基本上从 Catalyst 直接搬过来。不过有两项地方不同：

1。增加了应用开始需要装载的额外的模块：Amor::View::* ,读取 cdbi 相关的 relationship 的设定，并装载相应的模块。
2。改变 Action 的构造和运行方式。虽然可能他的做法更为简洁和优秀，不过为了我已有的代码不用作大的改动，就可以在新的 Amor 上面继续运行，还是做了这方面的修改。

历史一整天，直至晚上九点，终于全面宣告完成。其间出现了与之前一样的 Apache 意外终止的情况。问题出在 Class::DBI::Loader 初始化的时候，而在 Apache 配置文件中使用了类似 PerlModule xa 这样的一行，就会出错。注释掉之后就没有问题了。

后来调整 Action 相关的代码到没有花费太大的力气，却是在后来对 Session 的改造有些麻烦。笔记本的速度实在糟糕，怎么调试怎么出错。最终发现 mod_perl 和 mod_cgi 方式下读取 cookie 的 SESSION_ID 方式不太一样。

以后可能还是要完全调整到 Catalyst 框架下开发比较好，为了迎合自己的需要，可能需要写点儿 Plugin 之类的东西。好了，继续应用程序的开发。怎么说这次改造也算是一个小小的里程碑吧。