迁移邮局

公司业务调整，需要把一台邮件系统上的用户迁移到另一台新装的机器上。原来的系统使用的是 Qmail 新的系统用 Postfix 。令人欣慰的是，他们都用 Maildir 格式保存邮件。

要迁的只是部分用户。所以首先准备一份域名名单。然后在老系统上写一个脚本，使用 vpopmail 模块循环遍历取出所有这些域名下，所有用户的大小限额，Maildir 目录路径，密码的秘文，然后用 YAML 模块保存为一个 yaml 格式的文档。

传输到新系统。

在新系统中写一个脚本，根据 userdb 目录中的文件，解析出新服务器上已经开设的域名和用户，保存到一个哈希表中。使用 YAML 加载传输过来的老系统用户数据，比对一下，确认无误。然后更新这些用户的密码密文。

到此，IP 对换，用户一般只是感觉服务停顿了一小会儿。差别是，原来的邮件尚未到新系统，所以没什么新邮件。接下来迁移信件。

老系统 vpopmail 存放的用户邮件在各个用户目录下的 Maildir 目录中，主要是 cur 和 new 下面的文件。新系统的 userdb 中也保存类似的目录信息，通过和上面类似的解析方法取得。现在要将新系统上每个用户在老系统上的 cur new 目录中的文件复制过来。老系统上的数据很庞大，也并非每个域都需要迁移，况且几十个 G 的数据，如果 tar -z 的话也不轻松，未必剩余空间够用。

于是，我的第一个想法是，能否将老系统的文件系统挂到新系统上来，NFS? 不过没什么了解，第二个想法是用 Net::FTP 来实现。直接连接 ftp 去下载。虽然 cur new 下面不会再有子目录，不过仍然理想地希望可以一个命令一股脑儿全都拉过来。于是发现 Net::SFTP::Recursive 模块，看文档很爽，直接 remote 的一个目录复制到 local 的一个目录。不过安装颇费周折，前置模块安装过程失败，幸好 FreeBSD 的 ports 中有，于是先 cvsup ports 更新一下，然后安装这个前置模块。装好了，写个测试脚本尝试拉数据，居然无限递归，冒出了一大堆 ../../././ 这样的路径。然后直接修改它的源代码，忽略掉 . 和 .. 两个特殊目录，终于如愿以偿。于是放到实际的脚本中跑，开始拉数据，看着满屏幕滚，挺高兴，可大约过了5，6分钟，就不动了，按下回车，报告“connect closed at ....”然后退出。接连试了几次都老样子。怀疑老系统上 sshd 的问题，尝试修改配置还是不行，已经凌晨4点了，不得已只好先躺下。

今天一早起来，继续。既然 SFTP 行不通，索性看看 FTP 行不行，同样有个模块 Net::FTP::Recursive 不过用起来没有上面那个直观。测试了下，需要远端 CWD 到某个目录，然后本地 chdir 到某一个目录，然后运行 $ftp->rget(); 就可以了。实测了一下，基本上比较顺利，再加上相应的 chmod, chown 操作，然后就开始拉数据了，状态输出到日志文件，用 & 后端运行。tail -f log.tran 看看，基本没有问题，就关了电脑来公司上班。到公司一看，大约花了半个多小时，就跑完了。

兜了个很大的圈子，总算也是些有益的尝试。我可不愿一个一个域打包，再 ftp 传输，再解开，再写脚本投入相应的目录。罗嗦阿。宁愿万事一个脚本，一跑就结束。干干净净。

不知道谁有更好更优雅的方案可以解决类似的迁移问题的吗？